import React, { useEffect, useRef } from 'react';
import { View, StyleSheet, ActivityIndicator } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { LinearGradient } from 'expo-linear-gradient';
import { SvgXml } from 'react-native-svg';
import { useAuth } from '../../contexts/AuthContext';

// Logo MACha SVG
const MAChaLogoSVG = `<svg width="222" height="47" viewBox="0 0 222 47" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M43.5835 1.93499C46.7587 1.81121 50.2429 1.86352 53.4428 1.85238C53.5905 16.3114 53.2395 30.8068 53.4219 45.3336C50.2796 45.1842 46.2094 45.2355 43.0474 45.3043C43.3092 43.1759 43.1853 38.3859 43.1889 36.0568C43.2269 30.6442 43.2201 25.2301 43.1691 19.8175C39.1027 26.736 35.2042 33.8082 31.1006 40.7208L25.6985 40.819C24.2425 38.8986 22.6401 35.9645 21.3705 33.8243L13.4486 20.3009L13.4628 23.8356C13.4716 30.5812 13.2622 38.736 13.5648 45.3248C11.2033 45.2091 5.61832 45.1549 3.3689 45.3585L3.4231 24.7745C3.4231 21.1564 3.31499 16.9991 3.51626 13.4261C5.3665 11.4647 7.47866 9.61999 9.43071 7.74294C10.5589 6.65793 12.4115 4.59192 13.6143 3.80032C14.6026 4.73196 19.4618 13.0656 20.4553 14.8345C22.7876 18.988 26.1573 24.0948 28.3022 28.255C31.1711 22.7325 34.9814 17.0466 38.007 11.5545C39.0548 9.65222 40.2074 7.751 41.2766 5.85139C41.899 4.74529 42.8727 2.81273 43.5835 1.93499Z" fill="#62AC4A"/>
<path d="M151.025 0C154.075 0.17007 158.048 0.108691 161.109 0.0876007C161.259 4.94444 161.141 10.9122 161.1 15.8139L161.428 15.4608C166.04 10.5488 175.819 10.477 180.693 15.0519C185.591 19.6507 184.763 27.4056 184.759 33.5448C184.75 37.4647 184.775 41.3861 184.834 45.306C181.802 45.1947 177.605 45.1976 174.581 45.3133C174.685 41.8856 174.616 38.096 174.618 34.639C174.633 29.8255 176.011 20.2557 168.574 20.4696C160.191 20.7098 161.055 28.1952 161.08 34.1659L161.14 45.3089C157.86 45.1932 154.24 45.2679 150.943 45.2796C151.177 41.6395 151.002 36.3924 150.997 32.6205L150.986 12.1561C150.983 8.19418 150.906 3.94204 151.025 0Z" fill="#62AC4A"/>
<path d="M127.443 1.51951C129 1.25569 132.114 1.51438 133.64 1.70657C138.385 2.30408 143.859 4.97918 146.764 8.89236C145.429 10.5859 142.161 13.7847 140.56 15.437C140.47 15.3386 140.379 15.2408 140.288 15.144C137.415 12.1194 134.389 10.4923 130.112 10.3912C117.699 10.0978 112.462 25.2157 120.745 33.6371C123.133 36.0629 126.709 37.1073 130.069 37.0824C134.453 37.0487 137.317 35.2733 140.308 32.1913L141.161 32.9618C142.892 34.746 145.116 36.725 146.716 38.5766C139.378 47.871 123.461 48.1625 114.491 41.1591C109.885 37.6288 106.922 32.3685 106.29 26.6C105.61 20.8593 107.11 14.5388 110.755 9.97943C115.163 4.46517 120.612 2.2887 127.443 1.51951Z" fill="#62AC4A"/>
<path d="M203.576 11.9236C208.284 11.5326 214.024 12.1804 217.571 15.6188C222.284 20.1866 221.484 27.3014 221.464 33.3512C221.427 37.3751 221.439 41.399 221.497 45.4215C219.411 45.168 214.037 45.2442 211.799 45.3072C211.916 44.0006 211.905 43.0147 211.889 41.6949C210.93 42.754 210.294 43.3062 209.125 44.0855C208.886 42.3175 208.714 40.3326 208.519 38.544C211.365 35.3111 211.296 35.9278 211.201 31.482L210.936 31.4659C207.851 31.3106 208.027 28.359 205.588 26.9659C204.625 26.4151 202.964 28.5201 202.522 29.2247C200.543 32.3844 197.443 33.6734 199.933 37.5934C200.502 38.1046 200.985 38.3229 201.653 38.6861C201.495 41.0357 201.296 43.3839 201.057 45.7276C197.512 45.4947 194.985 44.9015 192.259 42.4771C188.716 39.3233 188.598 32.5353 192.066 29.3053C196.582 25.0968 205.428 25.9332 211.289 25.8863C211.076 24.7642 210.81 22.9683 210.085 22.0792C207.49 18.8975 201.529 19.7521 198.11 20.8883C196.822 21.3175 195.586 22.1129 194.519 22.8072C193.365 20.4708 192.24 18.1199 191.149 15.754C194.237 13.3896 199.769 12.178 203.576 11.9236Z" fill="#62AC4A"/>
<path d="M93.5069 16.3354C93.8895 16.4904 93.9865 16.5812 94.1983 17.0493C95.6198 20.1886 97.0426 23.3775 98.4691 26.5094C101.347 32.7555 104.186 39.0191 106.987 45.2989C103.362 45.2242 99.5607 45.2711 95.9208 45.2608C94.7128 43.0782 93.2355 38.9415 92.1442 36.482C86.1194 36.2535 78.6212 36.4601 72.4725 36.4688C71.9359 37.8561 71.3819 39.2359 70.8109 40.6085C70.139 42.1817 69.4861 43.7579 68.7307 45.2931C65.0396 45.2799 60.9376 45.1905 57.2844 45.3224C59.5125 43.1119 61.8055 41.0509 64.0705 38.9181C68.0926 35.0714 72.1618 31.273 76.2774 27.526C78.9711 30.485 79.555 31.9923 82.6245 28.4049C84.4416 28.3082 86.9528 28.3829 88.8228 28.3814C88.0908 26.7965 87.3433 25.2276 86.7076 23.6002C87.9319 21.7999 91.8566 17.8917 93.5069 16.3354Z" fill="#62AC4A"/>
<path d="M77.0959 1.90778C80.1643 1.76042 84.3652 1.88639 87.515 1.89006C88.7798 4.39979 89.7734 7.08396 91.0853 9.65783C88.6523 11.4657 86.2827 13.4968 83.9558 15.4489C83.517 15.3205 82.5477 12.9946 82.1556 12.3099C81.9341 12.8973 81.7266 13.5649 81.5246 14.1657C80.9874 15.7183 79.9194 18.2799 79.1095 19.6158C78.231 18.8736 77.6206 18.0754 76.637 17.4299L70.114 17.4318C70.6972 16.3571 71.597 14.0487 72.1058 12.8538C73.1473 10.408 74.2192 7.97501 75.3211 5.55568C75.78 4.53747 76.5111 2.75519 77.0959 1.90778Z" fill="#62AC4A"/>
<path d="M96.5282 7.63771C97.6463 8.73122 97.8383 9.42642 96.7767 10.5429L96.8147 10.7183C96.3295 11.2954 95.0304 12.4827 94.4194 13.0762C93.0533 14.3985 91.7129 15.7474 90.3991 17.1217C86.6768 20.978 83.3704 24.8101 79.8846 28.8926C76.5558 25.6655 74.3356 22.645 70.4709 19.252C72.1753 19.3034 74.2826 19.1228 75.9783 18.9744C76.5071 19.311 78.9051 21.6094 79.5373 22.1909C83.6175 17.416 91.2008 11.0038 96.5282 7.63771Z" fill="url(#paint0_linear_169_62)"/>
<path d="M68.8713 20.1284C69.8381 20.5898 73.924 24.9302 74.8824 25.957C71.3226 29.584 66.6764 33.7881 62.9302 37.3066C61.7962 38.2925 60.7134 39.3589 59.6299 40.4019C62.0587 34.6187 64.7713 29.0156 67.3543 23.3027C67.8346 22.2407 68.2893 21.1362 68.8713 20.1284Z" fill="#62AC4A"/>
<path d="M204.989 28.6348C205.555 28.8472 208.985 33.3457 209.61 34.1206L206.512 34.1528C206.54 37.3814 207.261 42.1875 207.611 45.5508L205.371 45.5654C204.838 45.665 203.289 45.7061 202.665 45.7354C203.1 41.8726 203.481 38.0039 203.809 34.1309C202.762 34.1045 201.81 34.1426 200.762 34.1836C201.937 32.9458 203.897 30.1143 204.989 28.6348Z" fill="#F97E2C"/>
<path d="M0.0175705 1.91357C3.76376 1.81352 7.85419 1.88837 11.6147 1.91972C9.79174 3.83969 7.5832 5.90059 5.68315 7.80035C4.80439 8.81856 1.03608 12.5579 0 13.2912L0.0175705 1.91357Z" fill="#F97E2C"/>
<path d="M96.5281 7.63745C99.7534 5.9873 104.705 2.96035 108.207 2.0293C105.268 3.81992 103.142 5.44224 100.513 7.64844C99.634 8.38584 97.5863 10.2104 96.8146 10.718L96.7767 10.5427C97.8382 9.42618 97.6462 8.73095 96.5281 7.63745Z" fill="#F97E2C"/>
<defs>
<linearGradient id="paint0_linear_169_62" x1="83.8643" y1="13.2557" x2="89.0463" y2="23.6909" gradientUnits="userSpaceOnUse">
<stop stop-color="#F86C1C"/>
<stop offset="1" stop-color="#FFB85C"/>
</linearGradient>
</defs>
</svg>`;

export default function SplashScreen({ navigation }) {
  const { isAuthenticated, loading } = useAuth();
  const startTimeRef = useRef(Date.now());

  useEffect(() => {
    if (!loading) {
      // Minimum splash screen duration (2 seconds)
      const minDuration = 2000;
      const elapsed = Date.now() - startTimeRef.current;
      const remaining = Math.max(0, minDuration - elapsed);

      const timer = setTimeout(() => {
        if (isAuthenticated) {
          // User is already logged in, go to MainTabs
          navigation.replace('MainTabs');
        } else {
          // User is not logged in, go to Login
          navigation.replace('Login');
        }
      }, remaining);

      return () => clearTimeout(timer);
    }
  }, [navigation, loading, isAuthenticated]);

  return (
    <LinearGradient
      colors={['#FFFFFF', '#FFB85C', '#62AC4A']}
      start={{ x: 1, y: 0 }}
      end={{ x: 0, y: 1 }}
      style={styles.container}
    >
      <SafeAreaView style={styles.safeArea}>
        <View style={styles.content}>
          <View style={styles.logoContainer}>
            <SvgXml xml={MAChaLogoSVG} width={222} height={47} />
          </View>
          <ActivityIndicator size="large" color="#FFFFFF" style={styles.loader} />
        </View>
      </SafeAreaView>
    </LinearGradient>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  safeArea: {
    flex: 1,
  },
  content: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  logoContainer: {
    marginBottom: 40,
  },
  loader: {
    marginTop: 20,
  },
});
